<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Paper Uploader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    #pdf-preview-pages canvas { border: 1px solid #e2e8f0; margin-bottom: 8px; max-width: 100%; }
    button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
    #progress-overlay, #custom-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5); z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    #crop-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        cursor: crosshair;
        z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<!-- Main Upload and Settings Section -->
<div id="upload-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
  <h1 class="text-2xl font-bold text-gray-800 mb-2">Quiz Paper Uploader</h1>
  <p class="text-gray-600 mb-6">Configure, upload, and generate a unique Quiz ID for your students.</p>

  <!-- Quiz Settings -->
  <div class="mb-6 border-b pb-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Quiz Settings</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="totalDuration" class="block text-sm font-medium text-gray-700">Total Duration (Minutes)</label>
        <input type="number" id="totalDuration" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 180">
      </div>
      <div>
        <label for="negativeWeightage" class="block text-sm font-medium text-gray-700">Negative Weightage (e.g., 0.25 for 1/4)</label>
        <input type="number" step="0.01" id="negativeWeightage" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0.25">
      </div>
      <div>
        <label for="totalQuestions" class="block text-sm font-medium text-gray-700">Total Questions (Auto-calculated)</label>
        <input type="number" id="totalQuestions" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
      </div>
    </div>
  </div>

  <!-- Quiz Structure -->
  <div class="mb-6 border-b pb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-700">2. Quiz Structure</h2>
      <button id="addPartBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">+ Add Part</button>
    </div>
    <div id="quizPartsContainer" class="space-y-3">
      <!-- Dynamic parts will be added here -->
    </div>
  </div>

  <!-- File Upload -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Upload Paper</h2>
    <div>
      <label for="questionFile" class="block text-sm font-medium text-gray-700 mb-1">Question Paper (.pdf, .txt, .md)</label>
      <label class="w-full flex items-center px-4 py-2 bg-white text-blue-500 rounded-lg shadow-sm tracking-wide uppercase border border-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white">
        <svg class="w-6 h-6 mr-2" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3V3h2v8z" /></svg>
        <span id="fileName" class="truncate">Select a file</span>
        <input type='file' id="questionFile" class="hidden" accept=".txt,.md,.pdf"/>
      </label>
    </div>
  </div>


  <button id="uploadBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700" disabled>
    Connecting...
  </button>
  <div id="errorBox" class="mt-4 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md" style="display:none;"></div>
</div>

<!-- Correction Section -->
<div id="correction-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-7xl" style="display: none;">
  <h1 class="text-2xl font-bold text-gray-800 mb-2">Preview & Construct Questions</h1>
  <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 mb-4 rounded-r-lg">
    <p class="font-bold">Instructions</p>
    <p class="mt-1">Click "Select Question Area" to enable crop mode. Click and drag over a question in the PDF preview to capture it. The captured image will appear in the Question Constructor.</p>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-[75vh]">
    <div class="flex flex-col">
        <div class="flex justify-between items-center mb-2">
             <h3 class="font-bold text-lg">PDF Preview</h3>
             <button id="cropModeBtn" class="bg-green-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-600 text-sm">Select Question Area</button>
        </div>
      	<div id="pdf-preview" class="relative border rounded-md p-2 overflow-auto bg-gray-50 flex-grow">
      	    <div id="pdf-preview-pages"></div>
            <div id="crop-overlay" style="display: none;">
                <canvas id="crop-visualizer" style="position: absolute; top: 0; left: 0;"></canvas>
            </div>
      	</div>
    </div>
    <div id="text-editor" class="flex flex-col">
      <div id="question-constructor" class="mb-4 p-4 border rounded-lg bg-gray-50">
        <h3 class="font-bold text-lg mb-2">Question Constructor</h3>
        <p class="text-sm text-gray-600 mb-4">After selecting an area, the image will appear below. You can also paste an image directly (`Ctrl+V`). Click "Add Question" to add it to the list.</p>
        <div id="paste-zone" class="w-full h-24 rounded-lg flex items-center justify-center text-gray-500 bg-white cursor-pointer border-2 border-dashed border-gray-300" tabindex="0">
          <p id="paste-text">Image will appear here after selection</p>
          <img id="paste-preview" class="max-h-full max-w-full" style="display:none;" />
        </div>
        <button id="addQuestionBtn" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Add Question <span id="currentQNumLabel" class="font-bold">1</span> to List</button>
      </div>
      <h3 class="font-bold text-lg mb-2 text-center">Final Questions (Separated by '---')</h3>
      <textarea id="finalQuestionsText" class="w-full h-full p-2 border border-gray-300 rounded-md flex-grow"></textarea>
      <div class="mt-4">
        <label for="answerKey" class="block text-sm font-medium text-gray-700 mb-1">Answer Key (Required)</label>
        <textarea id="answerKey" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter answers in order, separated by commas. e.g., B,A,D,C,..."></textarea>
      </div>
    </div>
  </div>
  <button id="generateBtn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">
    Finalize and Generate Quiz ID
  </button>
  <div id="correctionErrorBox" class="mt-4 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md" style="display:none;"></div>
</div>

<!-- Result Section -->
<div id="result-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md" style="display: none;">
  <div id="result" class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
    <p class="text-green-800 font-medium">Quiz Generated Successfully!</p>
    <p class="text-sm text-green-700 mt-1">Share this ID with your students:</p>
    <div class="mt-2 flex items-center justify-center bg-white p-2 border rounded-md">
      <code id="quizId" class="text-lg font-bold text-indigo-700"></code>
      <button id="copyBtn" class="ml-4 p-1 rounded-md hover:bg-gray-200">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
      </button>
    </div>
  </div>
</div>

<!-- Overlays -->
<div id="progress-overlay" style="display: none;">
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <p id="progress-text" class="font-semibold text-lg mb-4">Generating Quiz ID...</p>
  </div>
</div>
<div id="custom-modal-overlay" style="display: none;">
  <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
    <p id="modal-text" class="mb-6 text-gray-800"></p>
    <div id="modal-actions" class="flex justify-center space-x-4"></div>
  </div>
</div>


<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCtqTUgcNmEVpomhPOozHA_3iw4ZnaCJug",
    authDomain: "quiz-3d72e.firebaseapp.com",
    projectId: "quiz-3d72e",
    storageBucket: "quiz-3d72e.appspot.com",
    messagingSenderId: "843152315174",
    appId: "1:843152315174:web:e90ae825078e7d0c7ae7e7",
    measurementId: "G-L0J0BQP3QS"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentQuestionNumber = 1;
  let pastedImageAsBase64 = null;

  const $ = (selector) => document.querySelector(selector);

  function showScreen(screenId) {
    ['upload-section', 'correction-section', 'result-section'].forEach(id => {
      $(`#${id}`).style.display = (id === screenId) ? (id === 'upload-section' ? 'block' : 'block') : 'none';
    });
  }

  function showError(message, isCorrectionScreen = false) {
    const box = isCorrectionScreen ? $('#correctionErrorBox') : $('#errorBox');
    box.textContent = message;
    box.style.display = 'block';
  }

  function showModal(message, onConfirm) {
    $('#modal-text').textContent = message;
    $('#modal-actions').innerHTML = `<button id="modal-cancel" class="w-1/2 bg-gray-300 font-bold py-2 px-4 rounded-lg">Cancel</button><button id="modal-confirm" class="w-1/2 bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>`;
    $('#custom-modal-overlay').style.display = 'flex';
    $('#modal-confirm').onclick = () => { $('#custom-modal-overlay').style.display = 'none'; onConfirm(); };
    $('#modal-cancel').onclick = () => { $('#custom-modal-overlay').style.display = 'none'; };
  }

  function addQuizPart(name = '', qCount = '', marks = '') {
    const container = $('#quizPartsContainer');
    const partDiv = document.createElement('div');
    partDiv.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 items-center';
    partDiv.innerHTML = `
            <input type="text" class="part-name md:col-span-2 w-full p-2 border border-gray-300 rounded-md" placeholder="Part Name (e.g., Part A: Physics)" value="${name}">
            <input type="number" class="part-q-count w-full p-2 border border-gray-300 rounded-md" placeholder="# of Qs" value="${qCount}">
            <input type="number" class="part-marks w-full p-2 border border-gray-300 rounded-md" placeholder="Marks / Q" value="${marks}">
        `;
    container.appendChild(partDiv);
  }

  function updateTotalQuestions() {
    const counts = [...document.querySelectorAll('.part-q-count')].map(el => parseInt(el.value) || 0);
    const total = counts.reduce((sum, count) => sum + count, 0);
    $('#totalQuestions').value = total;
  }

  $('#quizPartsContainer').addEventListener('input', updateTotalQuestions);
  $('#addPartBtn').addEventListener('click', () => addQuizPart());

  $('#questionFile').addEventListener('change', (e) => {
    $('#fileName').textContent = e.target.files[0] ? e.target.files[0].name : 'Select a file';
  });

  $('#uploadBtn').addEventListener('click', async () => {
    $('#errorBox').style.display = 'none';

    if (!$('#totalDuration').value || !$('#negativeWeightage').value || !$('#totalQuestions').value || !$('#questionFile').files[0]) {
      showError('Please fill all settings and upload a file before continuing.');
      return;
    }

    $('#uploadBtn').disabled = true;
    $('#uploadBtn').textContent = 'Processing...';

    try {
      const file = $('#questionFile').files[0];
      const textContent = await (file.type === 'application/pdf' ? parsePdf(file) : readTextFile(file));
      $('#finalQuestionsText').value = textContent;
      showScreen('correction-section');
    } catch (err) {
      showError(err.message);
    } finally {
      $('#uploadBtn').disabled = false;
      $('#uploadBtn').textContent = 'Next: Construct Questions';
    }
  });

  $('#generateBtn').addEventListener('click', async () => {
    $('#correctionErrorBox').style.display = 'none';

    const answerKeyText = $('#answerKey').value.trim();
    const constructedQs = $('#finalQuestionsText').value.split('---').map(q => q.trim()).filter(Boolean);
    const expectedTotal = parseInt($('#totalQuestions').value, 10);

    if (!answerKeyText) {
      showError('Answer key is mandatory.', true);
      return;
    }
    if(constructedQs.length !== expectedTotal) {
      showError(`Mismatch: Expected ${expectedTotal} questions based on your settings, but found ${constructedQs.length}. Please correct the structure or add/remove questions.`, true);
      return;
    }

    $('#progress-text').textContent = 'Generating Quiz ID...';
    $('#progress-overlay').style.display = 'flex';

    try {
      const quizData = {
        duration: parseInt($('#totalDuration').value),
        negativeWeightage: parseFloat($('#negativeWeightage').value),
        structure: [...document.querySelectorAll('#quizPartsContainer > div')].map(div => ({
          name: div.querySelector('.part-name').value,
          count: parseInt(div.querySelector('.part-q-count').value),
          marks: parseFloat(div.querySelector('.part-marks').value)
        })),
        questions: constructedQs,
        answerKey: parseAnswerKey(answerKeyText),
        createdAt: new Date()
      };

      const docRef = await addDoc(collection(db, "quizzes"), quizData);
      $('#quizId').textContent = docRef.id;
      showScreen('result-section');
    } catch (err) {
      showError(err.message, true);
    } finally {
      $('#progress-overlay').style.display = 'none';
    }
  });

  $('#copyBtn').addEventListener('click', () => {
    const textToCopy = $('#quizId').textContent;
    const textArea = document.createElement('textarea');
    textArea.value = textToCopy;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      alert('Quiz ID copied to clipboard!');
    } catch (err) {
      alert('Failed to copy text.');
    }
    document.body.removeChild(textArea);
  });

  async function parsePdf(file) {
    await renderPdfPreview(file);
    return ""; // For PDFs, we expect manual construction.
  }

  function readTextFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = () => reject(new Error('Failed to read file.'));
      reader.readAsText(file);
    });
  }

  async function renderPdfPreview(file) {
    const reader = new FileReader();
    reader.readAsArrayBuffer(file);
    return new Promise((resolve, reject) => {
      reader.onload = async (e) => {
        try {
          pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
          const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
          const container = $('#pdf-preview-pages');
          container.innerHTML = '';
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 3.0 }); // Increased scale for better quality
            const canvas = document.createElement('canvas');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            container.appendChild(canvas);
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
          }
          resolve();
        } catch (error) { reject(new Error('Could not display PDF.')); }
      };
      reader.onerror = () => reject(new Error('Failed to read PDF.'));
    });
  }

  $('#paste-zone').addEventListener('paste', (e) => {
    e.preventDefault();
    const item = e.clipboardData.items[0];
    if (item.type.indexOf('image') !== -1) {
      const blob = item.getAsFile();
      const reader = new FileReader();
      reader.onload = function(event) {
        pastedImageAsBase64 = event.target.result;
        $('#paste-preview').src = pastedImageAsBase64;
        $('#paste-preview').style.display = 'block';
        $('#paste-text').style.display = 'none';
      };
      reader.readAsDataURL(blob);
    }
  });

  $('#addQuestionBtn').addEventListener('click', () => {
    if (!pastedImageAsBase64) { alert('Please select an area or paste an image first.'); return; }

    const markdownString = `**Q${currentQuestionNumber}.**\n![Question ${currentQuestionNumber}](${pastedImageAsBase64})\n`;
    const textArea = $('#finalQuestionsText');
    textArea.value += (textArea.value ? '\n---\n\n' : '') + markdownString;
    textArea.scrollTop = textArea.scrollHeight;

    currentQuestionNumber++;
    $('#currentQNumLabel').textContent = currentQuestionNumber;
    pastedImageAsBase64 = null;
    $('#paste-preview').style.display = 'none';
    $('#paste-text').style.display = 'block';
    $('#paste-preview').src = '';
  });

  function parseAnswerKey(text) {
    const key = {};
    const answers = text.split(',').map(ans => ans.trim()).filter(Boolean);
    answers.forEach((answer, index) => {
        key[index + 1] = answer.toUpperCase();
    });
    return key;
  }
  
  // --- Screenshot/Cropping Logic ---
  const cropModeBtn = $('#cropModeBtn');
  const pdfPreview = $('#pdf-preview');
  const cropOverlay = $('#crop-overlay');
  const cropVisualizer = $('#crop-visualizer');
  const cropCtx = cropVisualizer.getContext('2d');
  let isCropMode = false;
  let isDrawingCrop = false;
  let cropStart = { x: 0, y: 0 };

  cropModeBtn.addEventListener('click', () => {
      isCropMode = !isCropMode;
      if (isCropMode) {
          cropModeBtn.textContent = 'Cancel Selection';
          cropModeBtn.classList.replace('bg-green-500', 'bg-red-500');
          cropModeBtn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
          cropOverlay.style.display = 'block';
          resizeCropVisualizer();
      } else {
          cancelCropping();
      }
  });

  function cancelCropping() {
      isCropMode = false;
      isDrawingCrop = false;
      cropModeBtn.textContent = 'Select Question Area';
      cropModeBtn.classList.replace('bg-red-500', 'bg-green-500');
      cropModeBtn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
      cropOverlay.style.display = 'none';
  }

  function resizeCropVisualizer() {
      cropVisualizer.width = cropOverlay.clientWidth;
      cropVisualizer.height = cropOverlay.clientHeight;
  }
  new ResizeObserver(resizeCropVisualizer).observe(cropOverlay);

  cropOverlay.addEventListener('mousedown', (e) => {
      isDrawingCrop = true;
      cropStart.x = e.offsetX;
      cropStart.y = e.offsetY;
  });

  cropOverlay.addEventListener('mousemove', (e) => {
      if (!isDrawingCrop) return;
      const currentX = e.offsetX;
      const currentY = e.offsetY;
      
      cropCtx.clearRect(0, 0, cropVisualizer.width, cropVisualizer.height);
      cropCtx.fillStyle = 'rgba(0, 100, 255, 0.3)';
      cropCtx.fillRect(cropStart.x, cropStart.y, currentX - cropStart.x, currentY - cropStart.y);
      cropCtx.strokeStyle = 'rgba(0, 100, 255, 0.8)';
      cropCtx.strokeRect(cropStart.x, cropStart.y, currentX - cropStart.x, currentY - cropStart.y);
  });

  cropOverlay.addEventListener('mouseup', (e) => {
      if (!isDrawingCrop) return;
      isDrawingCrop = false;

      const cropEnd = { x: e.offsetX, y: e.offsetY };
      
      const rect = {
          x: Math.min(cropStart.x, cropEnd.x),
          y: Math.min(cropStart.y, cropEnd.y),
          width: Math.abs(cropStart.x - cropEnd.x),
          height: Math.abs(cropStart.y - cropEnd.y)
      };

      if (rect.width < 10 || rect.height < 10) {
          cancelCropping();
          return;
      }
      
      const pdfCanvases = [...$('#pdf-preview-pages').querySelectorAll('canvas')];
      let sourceCanvas = null;

      const clickPoint = {
          x: cropOverlay.getBoundingClientRect().left + rect.x,
          y: cropOverlay.getBoundingClientRect().top + rect.y,
      };

      for (const canvas of pdfCanvases) {
          const canvasRect = canvas.getBoundingClientRect();
          if (
              clickPoint.x >= canvasRect.left && clickPoint.x <= canvasRect.right &&
              clickPoint.y >= canvasRect.top && clickPoint.y <= canvasRect.bottom
          ) {
              sourceCanvas = canvas;
              break;
          }
      }

      if (!sourceCanvas) {
          alert('Selection must be made over a PDF page.');
          cancelCropping();
          return;
      }
      
      const sourceRect = sourceCanvas.getBoundingClientRect();
      const scale = sourceCanvas.width / sourceRect.width;

      const sx = (clickPoint.x - sourceRect.left) * scale;
      const sy = (clickPoint.y - sourceRect.top) * scale;
      const sWidth = rect.width * scale;
      const sHeight = rect.height * scale;
      
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = sWidth;
      tempCanvas.height = sHeight;
      const tempCtx = tempCanvas.getContext('2d');

      tempCtx.drawImage(
          sourceCanvas,
          sx, sy, sWidth, sHeight,
          0, 0, sWidth, sHeight
      );
      
      pastedImageAsBase64 = tempCanvas.toDataURL('image/png');
      $('#paste-preview').src = pastedImageAsBase64;
      $('#paste-preview').style.display = 'block';
      $('#paste-text').style.display = 'none';
      
      cancelCropping();
  });

  cropOverlay.addEventListener('mouseleave', () => {
      if(isDrawingCrop) {
          isDrawingCrop = false;
          cropCtx.clearRect(0, 0, cropVisualizer.width, cropVisualizer.height);
      }
  });


  // Initial Setup
  signInAnonymously(auth).then(() => {
    $('#uploadBtn').disabled = false;
    $('#uploadBtn').textContent = 'Next: Construct Questions';
    addQuizPart('Part A', '10', '4'); // Add one default part to start
    updateTotalQuestions();
  }).catch(error => {
    showError('Error: Could not connect to the database.');
    $('#uploadBtn').textContent = 'Connection Failed';
  });

</script>
</body>
</html>
