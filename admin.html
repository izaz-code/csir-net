<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Quiz Paper Uploader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
    #progress-overlay, #custom-modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5); z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<!-- Main Upload and Settings Section -->
<div id="upload-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-2xl">
  <h1 class="text-2xl font-bold text-gray-800 mb-2">AI Quiz Paper Uploader</h1>
  <p class="text-gray-600 mb-6">This tool uses a secure, server-side AI to automatically extract questions and the answer key from your PDF.</p>

  <!-- Quiz Settings -->
  <div class="mb-6 border-b pb-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Quiz Settings</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label for="totalDuration" class="block text-sm font-medium text-gray-700">Total Duration (Minutes)</label>
        <input type="number" id="totalDuration" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 180">
      </div>
      <div>
        <label for="negativeWeightage" class="block text-sm font-medium text-gray-700">Negative Weightage (e.g., 0.25 for 1/4)</label>
        <input type="number" step="0.01" id="negativeWeightage" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 0.25">
      </div>
    </div>
  </div>

  <!-- Quiz Structure -->
  <div class="mb-6 border-b pb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-700">2. Quiz Structure</h2>
      <button id="addPartBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm">+ Add Part</button>
    </div>
    <div id="quizPartsContainer" class="space-y-3">
      <!-- Dynamic parts will be added here -->
    </div>
  </div>

  <!-- File Upload -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold text-gray-700 mb-4">3. Upload & Process</h2>
    <div>
      <label for="questionFile" class="block text-sm font-medium text-gray-700 mb-1">Question Paper (.pdf)</label>
      <label class="w-full flex items-center px-4 py-2 bg-white text-blue-500 rounded-lg shadow-sm tracking-wide uppercase border border-blue-500 cursor-pointer hover:bg-blue-500 hover:text-white">
        <svg class="w-6 h-6 mr-2" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4 4-4-4h3V3h2v8z" /></svg>
        <span id="fileName" class="truncate">Select a PDF file</span>
        <input type='file' id="questionFile" class="hidden" accept=".pdf"/>
      </label>
    </div>
  </div>

  <button id="processBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700" disabled>
    Connect to AI Service...
  </button>
  <div id="errorBox" class="mt-4 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md" style="display:none;"></div>
</div>

<!-- Review Section -->
<div id="review-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl" style="display: none;">
  <h1 class="text-2xl font-bold text-gray-800 mb-2">Review & Finalize</h1>
  <p class="text-gray-600 mb-6">The AI has extracted the questions and answer key. Please review them before generating the quiz ID.</p>
  
  <div class="h-[60vh] flex flex-col">
      <h3 class="font-bold text-lg mb-2 text-center">Extracted Questions (Separated by '---')</h3>
      <textarea id="finalQuestionsText" class="w-full h-full p-2 border border-gray-300 rounded-md flex-grow"></textarea>
      
      <div class="mt-4">
          <label for="totalQuestions" class="block text-sm font-medium text-gray-700">Total Questions (AI Detected)</label>
          <input type="number" id="totalQuestions" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
      </div>

      <div class="mt-4">
        <div class="flex justify-between items-center mb-1">
            <label for="answerKey" class="block text-sm font-medium text-gray-700">Answer Key</label>
            <span id="answerKeyStatus" class="text-xs font-medium"></span>
        </div>
        <textarea id="answerKey" rows="1" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g., BADC... (no spaces or commas)"></textarea>
      </div>
  </div>
  
  <button id="generateBtn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">
    Generate Quiz ID
  </button>
  <div id="reviewErrorBox" class="mt-4 p-3 bg-red-50 text-red-700 border border-red-200 rounded-md" style="display:none;"></div>
</div>


<!-- Result Section -->
<div id="result-section" class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md" style="display: none;">
  <div id="result" class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
    <p class="text-green-800 font-medium">Quiz Generated Successfully!</p>
    <p class="text-sm text-green-700 mt-1">Share this ID with your students:</p>
    <div class="mt-2 flex items-center justify-center bg-white p-2 border rounded-md">
      <code id="quizId" class="text-lg font-bold text-indigo-700"></code>
      <button id="copyBtn" class="ml-4 p-1 rounded-md hover:bg-gray-200">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
      </button>
    </div>
  </div>
</div>

<!-- Overlays -->
<div id="progress-overlay" style="display: none;">
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <p id="progress-text" class="font-semibold text-lg mb-4">Processing...</p>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyCtqTUgcNmEVpomhPOozHA_3iw4ZnaCJug",
    authDomain: "quiz-3d72e.firebaseapp.com",
    projectId: "quiz-3d72e",
    storageBucket: "quiz-3d72e.appspot.com",
    messagingSenderId: "843152315174",
    appId: "1:843152315174:web:e90ae825078e7d0c7ae7e7"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const $ = (selector) => document.querySelector(selector);

  function showScreen(screenId) {
    ['upload-section', 'review-section', 'result-section'].forEach(id => {
      $(`#${id}`).style.display = (id === screenId) ? 'block' : 'none';
    });
  }

  function showError(message, screen = 'upload') {
    const box = screen === 'review' ? $('#reviewErrorBox') : $('#errorBox');
    box.textContent = message;
    box.style.display = 'block';
  }

  function addQuizPart(name = '', qCount = '', marks = '', maxQ = '') {
    const container = $('#quizPartsContainer');
    const partDiv = document.createElement('div');
    partDiv.className = 'grid grid-cols-1 md:grid-cols-5 gap-2 items-center';
    partDiv.innerHTML = `
            <input type="text" class="part-name md:col-span-2 w-full p-2 border border-gray-300 rounded-md" placeholder="Part Name" value="${name}">
            <input type="number" class="part-q-count w-full p-2 border border-gray-300 rounded-md" placeholder="# of Qs" value="${qCount}">
            <input type="number" class="part-marks w-full p-2 border border-gray-300 rounded-md" placeholder="Marks / Q" value="${marks}">
            <input type="number" class="part-max-q w-full p-2 border border-gray-300 rounded-md" placeholder="Max Attempts" value="${maxQ}">
        `;
    container.appendChild(partDiv);
  }

  $('#addPartBtn').addEventListener('click', () => addQuizPart());
  $('#questionFile').addEventListener('change', (e) => {
    $('#fileName').textContent = e.target.files[0] ? e.target.files[0].name : 'Select a PDF file';
  });

  $('#processBtn').addEventListener('click', async () => {
    $('#errorBox').style.display = 'none';
    const file = $('#questionFile').files[0];

    if (!$('#totalDuration').value || !$('#negativeWeightage').value || !file) {
      showError('Please fill all settings and upload a file before processing.');
      return;
    }
    
    const progressOverlay = $('#progress-overlay');
    const progressText = $('#progress-text');
    progressText.textContent = 'Securely uploading and processing with AI... This may take a moment.';
    progressOverlay.style.display = 'flex';

    // This is where you would call your secure backend API
    // const formData = new FormData();
    // formData.append('pdfFile', file);
    // const response = await fetch('YOUR_SECURE_BACKEND_URL/process-quiz', {
    //   method: 'POST',
    //   body: formData,
    // });
    // const aiResult = await response.json();

    // --- MOCK FUNCTION to simulate the backend response ---
    const mockAIProcessing = () => new Promise(resolve => setTimeout(() => resolve({
        questions: ["**Q1.**\n![Question 1](https://placehold.co/600x400/EEE/31343C?text=Mock+Question+1)","**Q2.**\n![Question 2](https://placehold.co/600x400/EEE/31343C?text=Mock+Question+2)"],
        answerKey: "BA",
        structure: [{ name: "Part A", count: 2, marks: 4, maxQuestions: 2 }]
    }), 3000));
    
    try {
        const aiResult = await mockAIProcessing();
        
        $('#finalQuestionsText').value = aiResult.questions.join('\n---\n\n');
        $('#totalQuestions').value = aiResult.questions.length;
        
        const answerKeyStatus = $('#answerKeyStatus');
        if (aiResult.answerKey) {
            $('#answerKey').value = aiResult.answerKey;
            answerKeyStatus.textContent = '✓ AI Detected';
            answerKeyStatus.className = 'text-xs font-medium text-green-600';
        } else {
            answerKeyStatus.textContent = '⚠ Not Found';
            answerKeyStatus.className = 'text-xs font-medium text-yellow-600';
        }

        $('#quizPartsContainer').innerHTML = '';
        aiResult.structure.forEach(part => addQuizPart(part.name, part.count, part.marks, part.maxQuestions));

        showScreen('review-section');
    } catch (err) {
      showError(`An error occurred during AI processing: ${err.message}`);
    } finally {
      progressOverlay.style.display = 'none';
    }
  });

  $('#generateBtn').addEventListener('click', async () => {
    $('#reviewErrorBox').style.display = 'none';

    const answerKeyText = $('#answerKey').value.trim();
    if (!answerKeyText) {
      showError('Answer key is mandatory.', 'review');
      return;
    }
    
    $('#progress-text').textContent = 'Generating Quiz ID...';
    $('#progress-overlay').style.display = 'flex';

    try {
      const quizData = {
        duration: parseInt($('#totalDuration').value),
        negativeWeightage: parseFloat($('#negativeWeightage').value),
        structure: [...document.querySelectorAll('#quizPartsContainer > div')].map(div => ({
          name: div.querySelector('.part-name').value,
          count: parseInt(div.querySelector('.part-q-count').value),
          marks: parseFloat(div.querySelector('.part-marks').value),
          maxQuestions: parseInt(div.querySelector('.part-max-q').value)
        })),
        questions: $('#finalQuestionsText').value.split('---').map(q => q.trim()).filter(Boolean),
        answerKey: parseAnswerKey(answerKeyText),
        createdAt: new Date()
      };

      const docRef = await addDoc(collection(db, "quizzes"), quizData);
      $('#quizId').textContent = docRef.id;
      showScreen('result-section');
    } catch (err) {
      showError(err.message, 'review');
    } finally {
      $('#progress-overlay').style.display = 'none';
    }
  });

  $('#copyBtn').addEventListener('click', () => {
    const textToCopy = $('#quizId').textContent;
    const textArea = document.createElement('textarea');
    textArea.value = textToCopy;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      alert('Quiz ID copied to clipboard!');
    } catch (err) {
      alert('Failed to copy text.');
    }
    document.body.removeChild(textArea);
  });
  
  function parseAnswerKey(text) {
    const key = {};
    const answers = text.replace(/[^A-Da-d]/g, '').split('');
    answers.forEach((answer, index) => {
        key[index + 1] = answer.toUpperCase();
    });
    return key;
  }

  signInAnonymously(auth).then(() => {
    $('#processBtn').disabled = false;
    $('#processBtn').textContent = 'Upload and Process with AI';
    addQuizPart('Part A', '10', '4', '10'); // Add one default part
  }).catch(error => {
    showError('Error: Could not connect to the AI service.');
    $('#processBtn').textContent = 'Connection Failed';
  });

</script>
</body>
</html>

