<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* * ==============================================
         * GLOBAL STYLES & COLOR PALETTE
         * ==============================================
        */
        :root {
            --color-save: #16a34a;        /* Green: Answered */
            --color-review-lock: #8b5cf6; /* Violet: Answered and Marked for Review */
            --color-review: #f59e0b;      /* Yellow: Marked for Review */
            --color-not-answered: #ef4444; /* Red: Not Answered (Visited) */
            --color-not-visited: #6b7280;  /* Gray: Not Visited */
            --part-header-bg: #4A5568;      /* Slate Gray */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        button:disabled { background-color: #d1d5db; cursor: not-allowed; opacity: 0.7; }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; }

        /* OMR Style Option Buttons */
        .omr-option {
            display: flex;
            align-items: center;
            gap: 0.4rem; /* 6px */
            cursor: pointer;
            padding: 0.25rem; /* Reduced padding */
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .omr-option:hover {
            background-color: #f0f3f8; /* A light blueish-gray on hover */
        }
        .option-btn {
            border: 2px solid #4a5568; /* Darker border */
            background-color: #ffffff;
            transition: all 0.2s ease;
            width: 20px; /* Reduced from 24px */
            height: 20px; /* Reduced from 24px */
            border-radius: 9999px; /* Circle */
            position: relative; /* For pseudo-element */
            flex-shrink: 0; /* Prevent the circle from shrinking */
        }
        .omr-option:hover .option-btn {
            border-color: #3b82f6; /* Blue on hover */
        }
        .option-btn.selected::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px; /* Inner circle size, reduced from 14px */
            height: 12px; /* Inner circle size, reduced from 14px */
            border-radius: 9999px;
            background-color: #374151; /* Dark fill color */
            transition: all 0.2s ease;
        }
        
        .palette-part-header { background-color: #e5e7eb; padding: 0.4rem 0.6rem; border-radius: 0.25rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-top: 0.5rem; font-size: 0.75rem; }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(28px, 1fr)); gap: 0.25rem; padding: 0.5rem; background-color: #ffffff; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 0.25rem 0.25rem; max-height: 200px; overflow-y: auto; transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out, border 0.3s ease-in-out; }
        .palette-grid.hidden { max-height: 0; padding: 0; overflow: hidden; border: none; }
        .palette-item { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; font-weight: 600; color: white; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; font-size: 0.7rem;}
        .palette-item.current { transform: scale(1.1); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.7); z-index: 10; }
        
        .palette-item.not-visited { background-color: var(--color-not-visited); }
        .palette-item.not-answered { background-color: var(--color-not-answered); }
        .palette-item.answered { background-color: var(--color-save); }
        .palette-item.review { background-color: var(--color-review); }
        .palette-item.review-lock { background-color: var(--color-review-lock); }

        .palette-legend { display: grid; grid-template-columns: 1fr; gap-y: 1; font-size: 0.7rem; }
        .legend-item { display: flex; align-items: center; gap: 0.4rem; }
        .legend-color-box { width: 12px; height: 12px; border-radius: 3px; }
        
        .btn-save { background-color: var(--color-save); }
        .btn-review-lock { background-color: var(--color-review-lock); }
        .btn-review { background-color: var(--color-review); }
        .btn-clear { background-color: var(--color-not-answered); }

        /* * ==============================================
         * CALCULATOR STYLES
         * ==============================================
        */
        #calculator-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 110;
            background-color: #1f2937;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 260px; 
            padding: 0.25rem;
            color: white;
            display: none;
            resize: both;
            overflow: auto;
            min-width: 260px;
            min-height: 330px;
        }
        #calculator-header {
            cursor: move;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #4b5563;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #calculator-display {
            background-color: #374151;
            color: white;
            border: none;
            width: 100%;
            padding: 0.5rem;
            text-align: right;
            font-size: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 0.25rem;
            min-height: 50px;
            -webkit-user-select: text; /* Allow text selection */
            user-select: text;
            cursor: text;
        }
        #calculator-mode {
            cursor: pointer;
            user-select: none;
        }
        .calc-mode-option {
            transition: all 0.2s ease;
        }
        .calc-mode-option.active {
            color: #f59e0b;
            font-weight: 700;
        }
        #calculator-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.2rem;
            margin-top: 0.25rem;
        }
        .calc-btn {
            background-color: #4b5563;
            border-radius: 0.5rem;
            padding: 0.4rem;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        .calc-btn:hover { background-color: #6b7280; }
        .calc-btn.operator { background-color: #f59e0b; }
        .calc-btn.operator:hover { background-color: #f59e0b; filter: brightness(1.2); }
        .calc-btn.clear-entry { background-color: #f97316; }
        .calc-btn.clear-entry:hover { background-color: #f97316; filter: brightness(1.2); }
        
        .calc-btn.shift-btn {
            background-color: #3b82f6; 
        }
        .calc-btn.shift-btn:hover {
            filter: brightness(1.2);
        }
        .calc-btn.shift-btn.active {
            box-shadow: inset 0 0 0 2px white;
        }

        .calc-btn.shiftable {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
            padding: 0.1rem;
        }
        .shift-primary-text, .shift-secondary-text {
            transition: all 0.2s ease;
        }
        .shift-primary-text { font-size: 0.875rem; color: white; }
        .shift-secondary-text { 
            font-size: 0.6rem; 
            color: #93c5fd;
        }
        #calculator-modal.shift-active .shift-primary-text { 
            font-size: 0.6rem; 
            color: #93c5fd;
        }
        #calculator-modal.shift-active .shift-secondary-text { 
            font-size: 0.875rem; 
            color: white; 
        }
        #calculator-modal.shift-active .shiftable { flex-direction: column-reverse; }

    </style>
</head>
<body>
    <div id="login-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">Enter Quiz</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label for="userName" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="userName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., John Doe">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="userEmail" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., john.doe@example.com">
                </div>
                <div>
                    <label for="quizIdInput" class="block text-sm font-medium text-gray-700">Quiz ID</label>
                    <input type="text" id="quizIdInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Enter the ID provided by your instructor">
                </div>
            </div>
            <button id="startQuizBtn" class="mt-8 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700" disabled>Connecting...</button>
            <div id="loginError" class="mt-4 text-red-600 font-medium" style="display:none;"></div>
        </div>
    </div>

    <div id="instructions-section" class="max-w-4xl mx-auto p-4 md:p-8" style="display: none;">
        <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6 text-center">Quiz Instructions</h2>
            <div class="text-gray-700 space-y-4 text-sm md:text-base">
                <p>Please read the following instructions carefully before you begin the test.</p>
                <h3 class="font-bold text-lg mt-6">Question Palette Legend:</h3>
                <p>The palette on the right side of your screen helps you navigate questions. Each color indicates the status of a question:</p>
                
                <div class="my-4 p-4 border rounded-lg bg-gray-50 flex justify-center">
                     <div class="space-y-2">
                        <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: var(--color-save);"></div><span>Answered</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: var(--color-not-answered);"></div><span>Not Answered</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: var(--color-review);"></div><span>Marked for Review</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: var(--color-review-lock);"></div><span>Answered & Marked for Review</span></div>
                        <div class="flex items-center gap-3"><div class="w-5 h-5 rounded" style="background-color: var(--color-not-visited);"></div><span>Not Visited</span></div>
                    </div>
                </div>

                <h3 class="font-bold text-lg mt-6">General Instructions:</h3>
                <ul class="list-disc list-inside pl-4">
                    <li>The timer will start as soon as you click the "Start Test" button.</li>
                    <li>You can navigate between questions using the palette or the "Previous" and "Next" buttons.</li>
                    <li>The quiz will be submitted automatically when the time runs out.</li>
                </ul>
            </div>
            <div class="mt-8 text-center">
                <button id="startTestNowBtn" class="bg-green-600 text-white font-bold py-3 px-12 rounded-lg hover:bg-green-700 text-lg">Start Test</button>
            </div>
        </div>
    </div>
    
    <!-- =================================================================================== -->
    <!--                                  QUIZ CONTAINER (RESTRUCTURED)                      -->
    <!-- =================================================================================== -->
    <div class="quiz-container max-w-7xl mx-auto p-4 flex-col gap-4" style="display: none;">
    
        <!-- Top Bar: Contains user info, timer, and calculator button -->
        <div id="info-timer-panel" class="bg-teal-100 rounded-lg shadow border border-gray-200 w-full flex items-center justify-between p-3">
            <!-- Left side: Calculator and Timer -->
            <div class="flex items-center gap-4">
                <button id="calculatorBtn" class="bg-gray-200 text-gray-700 p-1.5 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="4" y="2" width="16" height="20" rx="2"></rect><path d="M8 6h8"></path><path d="M8 10h.01"></path><path d="M12 10h.01"></path><path d="M16 10h.01"></path><path d="M8 14h.01"></path><path d="M12 14h.01"></path><path d="M16 14h.01"></path><path d="M8 18h8"></path>
                    </svg>
                </button>
                <div id="timer" class="text-center">
                    <p class="text-xs uppercase tracking-wider text-gray-500">Time Remaining</p>
                    <p id="timeDisplay" class="text-xl font-bold tracking-wider text-gray-800">00:00:00</p>
                </div>
            </div>
            
            <!-- Right side: Name and ID -->
            <div>
                <h3 id="sidebarStudentName" class="font-bold text-sm md:text-base text-gray-900 truncate text-right">Student Name</h3>
                <p class="text-xs text-gray-500 text-right">Quiz ID: <span id="sidebarQuizId" class="font-mono"></span></p>
            </div>
        </div>

        <!-- Main Content Area: Contains question and sidebar -->
        <div class="flex flex-col md:flex-row gap-4">
            <div class="main-content md:order-1 w-full md:flex-[3]">
                <div class="bg-white rounded-lg shadow border border-gray-200">
                    <div id="part-header" class="flex items-center justify-center gap-2 p-2 rounded-t-lg text-sm font-bold uppercase text-white" style="background-color: var(--part-header-bg);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        <span id="part-name-display">Part Name</span>
                    </div>
                    <div class="p-4">
                        <p id="question-number-display" class="text-lg font-bold text-gray-800 mb-2"></p>
                        <div id="question-content" class="mb-4 flex justify-center items-center bg-gray-50 rounded-lg p-2 border border-gray-200 overflow-hidden">
                            <img id="question-image" src="" alt="Question Content" class="max-w-full h-auto object-contain">
                        </div>
                        <div id="options-container" class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-2 mb-4 justify-items-start">
                           <div class="omr-option" data-option="A">
                                <button class="option-btn"></button>
                                <span class="font-semibold text-gray-700 text-sm">A</span>
                            </div>
                             <div class="omr-option" data-option="B">
                                <button class="option-btn"></button>
                                <span class="font-semibold text-gray-700 text-sm">B</span>
                            </div>
                             <div class="omr-option" data-option="C">
                                <button class="option-btn"></button>
                                <span class="font-semibold text-gray-700 text-sm">C</span>
                            </div>
                             <div class="omr-option" data-option="D">
                                <button class="option-btn"></button>
                                <span class="font-semibold text-gray-700 text-sm">D</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-4 pt-4 border-t">
                            <button id="reviewBtn" class="w-full text-white font-semibold py-2 px-1 text-xs rounded-md btn-review justify-center">Review</button>
                            <button id="reviewLockBtn" class="w-full text-white font-semibold py-2 px-1 text-xs rounded-md btn-review-lock justify-center">Review & Lock</button>
                            <button id="clearBtn" class="w-full text-white font-semibold py-2 px-1 text-xs rounded-md btn-clear justify-center">Clear</button>
                            <button id="saveBtn" class="w-full text-white font-semibold py-2 px-1 text-xs rounded-md btn-save justify-center">Save & Next</button>
                        </div>
                        <div class="flex justify-between items-center">
                            <button id="prevBtn" class="bg-gray-600 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-700">&larr;</button>
                            <button id="nextBtn" class="bg-gray-600 text-white font-semibold py-1 px-3 text-sm rounded-md hover:bg-gray-700">&rarr;</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar md:order-2 w-full md:flex-[1] flex flex-col gap-4">
                <div id="palette-container" class="bg-white rounded-lg shadow border border-gray-200 p-3 flex-1">
                    <h3 class="font-bold text-base mb-2">Question Palette</h3>
                    <div id="palette-parts-container"></div>
                </div>
    
                <button id="finalSubmitBtn" class="w-full bg-violet-600 text-white font-bold py-2 px-3 text-sm rounded-lg hover:bg-violet-700">Submit Quiz</button>
            </div>
        </div>
    </div>


    <div id="confirm-modal-overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-60 z-[100] flex items-center justify-center" style="display: none;">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md text-center">
            <h3 id="confirm-modal-title" class="text-xl font-bold mb-4">Confirm Submission</h3>
            <p id="confirm-modal-text" class="mb-6 text-gray-700"></p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="px-6 py-2 bg-gray-300 rounded-lg font-medium hover:bg-gray-400">Cancel</button>
                <button id="modal-confirm-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">Submit</button>
            </div>
        </div>
    </div>

    <div id="calculator-modal">
        <div id="calculator-header">
            <span class="font-bold">Calculator</span>
            <button id="close-calculator-btn" class="text-2xl">&times;</button>
        </div>
        <div id="calculator-display" contenteditable="true" inputmode="none">0</div>
        <div id="calculator-mode" class="text-xs text-gray-400 mt-2 px-1 flex justify-end items-center gap-2">
            <span class="calc-mode-option active" data-mode="deg">DEG</span>
            <span class="calc-mode-option" data-mode="rad">RAD</span>
        </div>
        <div id="calculator-buttons">
            <button class="calc-btn shift-btn" data-value="shift">Shift</button>
            <button class="calc-btn operator shiftable" data-value="sin">
                <span class="shift-secondary-text">sin⁻¹</span>
                <span class="shift-primary-text">sin</span>
            </button>
            <button class="calc-btn operator shiftable" data-value="cos">
                <span class="shift-secondary-text">cos⁻¹</span>
                <span class="shift-primary-text">cos</span>
            </button>
            <button class="calc-btn operator shiftable" data-value="tan">
                <span class="shift-secondary-text">tan⁻¹</span>
                <span class="shift-primary-text">tan</span>
            </button>
            <button class="calc-btn clear-entry" data-value="CE">CE</button>

            <button class="calc-btn operator" data-value="x-squared">x²</button>
            <button class="calc-btn operator" data-value="^">x<sup>y</sup></button>
            <button class="calc-btn operator" data-value="sqrt">√</button>
            <button class="calc-btn operator shiftable" data-value="reciprocal">
                <span class="shift-secondary-text">+/-</span>
                <span class="shift-primary-text">1/x</span>
            </button>
            <button class="calc-btn" data-value="backspace">Bksp</button>
            
            <button class="calc-btn" data-value="7">7</button>
            <button class="calc-btn" data-value="8">8</button>
            <button class="calc-btn" data-value="9">9</button>
            <button class="calc-btn operator" data-value="/">/</button>
            <button class="calc-btn operator" data-value="pi">π</button>
            
            <button class="calc-btn" data-value="4">4</button>
            <button class="calc-btn" data-value="5">5</button>
            <button class="calc-btn" data-value="6">6</button>
            <button class="calc-btn operator" data-value="*">*</button>
            <button class="calc-btn" data-value="move-left">←</button>
            
            <button class="calc-btn" data-value="1">1</button>
            <button class="calc-btn" data-value="2">2</button>
            <button class="calc-btn" data-value="3">3</button>
            <button class="calc-btn operator" data-value="-">-</button>
            <button class="calc-btn" data-value="move-right">→</button>
            
            <button class="calc-btn" data-value="00">00</button>
            <button class="calc-btn" data-value="0">0</button>
            <button class="calc-btn" data-value=".">.</button>
            <button class="calc-btn operator" data-value="+">+</button>
            <button class="calc-btn operator" data-value="=">=</button>
        </div>
    </div>


<script type="module">
    // ===================================================================================
    //                                  FIREBASE SETUP
    // ===================================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCtqTUgcNmEVpomhPOozHA_3iw4ZnaCJug",
        authDomain: "quiz-3d72e.firebaseapp.com",
        projectId: "quiz-3d72e",
        storageBucket: "quiz-3d72e.appspot.com",
        messagingSenderId: "843152315174",
        appId: "1:843152315174:web:e90ae825078e7d0c7ae7e7"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // ===================================================================================
    //                                  APPLICATION LOGIC
    // ===================================================================================

    let quizData = null;
    let answerKey = null;
    let currentQuestionIndex = 0;
    let questionStates = [];
    let userAnswers = [];
    let timerInterval = null;
    let quizConfig = {};
    const ADMIN_EMAIL = "ahamedizaz400@gmail.com";

    const $ = (selector) => document.querySelector(selector);

    // --- Authentication ---
    (async () => {
        try {
            await signInAnonymously(auth);
            $('#startQuizBtn').disabled = false;
            $('#startQuizBtn').textContent = 'Start Quiz';
        } catch (error) {
            console.error("Firebase sign-in failed:", error);
            $('#startQuizBtn').textContent = 'Connection Failed';
            $('#loginError').textContent = 'Could not connect. Please check internet.';
            $('#loginError').style.display = 'block';
        }
    })();

    // --- Event Listeners ---
    $('#startQuizBtn').addEventListener('click', startQuiz);
    $('#startTestNowBtn').addEventListener('click', () => {
        $('#instructions-section').style.display = 'none';
        $('.quiz-container').style.display = 'flex';
        displayQuestion(0);
        startTimer(quizConfig.duration);
    });
    $('#prevBtn').addEventListener('click', () => navigate(-1));
    $('#nextBtn').addEventListener('click', () => navigate(1));
    $('#saveBtn').addEventListener('click', handleSave);
    $('#reviewBtn').addEventListener('click', handleReview);
    $('#reviewLockBtn').addEventListener('click', handleReviewLock);
    $('#clearBtn').addEventListener('click', handleClear);
    $('#finalSubmitBtn').addEventListener('click', confirmSubmit);

    $('#options-container').addEventListener('click', (e) => {
        const omrOption = e.target.closest('.omr-option');
        if (omrOption && !questionStates[currentQuestionIndex].locked) {
            userAnswers[currentQuestionIndex] = omrOption.dataset.option;
            if (['not-answered', 'not-visited'].includes(questionStates[currentQuestionIndex].status)) {
                 questionStates[currentQuestionIndex].status = 'answered';
            }
            updateQuestionUI();
        }
    });

    // --- Quiz Core ---
    async function startQuiz() {
        const name = $('#userName').value.trim();
        const email = $('#userEmail').value.trim();
        const quizId = $('#quizIdInput').value.trim();

        if (!validateInputs(name, email, quizId)) return;
        setLoginLoading(true);

        try {
            const quizDoc = await getDoc(doc(db, "quizzes", quizId));
            if (!quizDoc.exists()) throw new Error("Invalid Quiz ID.");
            
            quizData = quizDoc.data();
            answerKey = quizData.answerKey || {};
            quizConfig = {
                duration: quizData.duration || 180,
                negativeWeightage: quizData.negativeWeightage || 0,
                structure: quizData.structure || []
            };

            if (email !== ADMIN_EMAIL) {
                const q = query(collection(db, "quizzes", quizId, "attempts"), where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) throw new Error("You have already attempted this quiz.");
            }
            
            initializeQuizState(quizData.questions.length);
            buildPalette(quizConfig.structure);
            
            $('#sidebarStudentName').textContent = name;
            $('#sidebarQuizId').textContent = quizId;
            $('#login-overlay').style.display = 'none';
            $('#instructions-section').style.display = 'block';

        } catch (err) {
            handleLoginError(err);
        } finally {
            setLoginLoading(false);
        }
    }

    function initializeQuizState(qCount) {
        userAnswers = Array(qCount).fill(null);
        questionStates = Array(qCount).fill(null).map(() => ({ status: 'not-visited', locked: false }));
    }

    function displayQuestion(index) {
        currentQuestionIndex = index;
        if (questionStates[index].status === 'not-visited') {
            questionStates[index].status = 'not-answered';
        }
        const imgUrl = (quizData.questions[index] || "").match(/\((.*?)\)/); 
        $('#question-image').src = imgUrl ? imgUrl[1] : '';
        $('#question-number-display').textContent = `Question ${index + 1}`;
        updatePartHeader(index);
        updateQuestionUI();
        updatePaletteFolding(index); // Auto-fold/unfold palette sections
    }
    
    // --- UI Updates ---
    function updateQuestionUI() {
        const state = questionStates[currentQuestionIndex];
        const answer = userAnswers[currentQuestionIndex];
        
        document.querySelectorAll('.omr-option').forEach(opt => {
            const btn = opt.querySelector('.option-btn');
            if (btn) {
                btn.classList.toggle('selected', opt.dataset.option === answer);
            }
        });

        $('#prevBtn').disabled = currentQuestionIndex === 0;
        $('#nextBtn').disabled = currentQuestionIndex === quizData.questions.length - 1;
        ['#saveBtn', '#clearBtn', '#reviewBtn', '#reviewLockBtn'].forEach(sel => $(sel).disabled = state.locked);
        updatePalette();
    }

    function updatePalette() {
        questionStates.forEach((state, index) => {
            const item = $(`#q-palette-${index + 1}`);
            if (item) {
                item.className = 'palette-item';
                item.classList.add(state.status);
                item.classList.toggle('current', index === currentQuestionIndex);
            }
        });
    }

    function updatePaletteFolding(currentQuestionIndex) {
        let qCounter = 0;
        quizConfig.structure.forEach((part, partIndex) => {
            const partId = `part-palette-${partIndex}`;
            const partGrid = $(`#${partId}`);
            const partArrow = $(`#arrow-${partId}`);

            if (!partGrid || !partArrow) return;

            // Check if the current question is in this part
            if (currentQuestionIndex >= qCounter && currentQuestionIndex < qCounter + part.count) {
                // This is the active part, so expand it.
                partGrid.classList.remove('hidden');
                partArrow.textContent = '▼';
            } else {
                // This is an inactive part, so collapse it.
                partGrid.classList.add('hidden');
                partArrow.textContent = '►';
            }
            qCounter += part.count;
        });
    }
    
    function buildPalette(parts) {
        const container = $('#palette-parts-container');
        container.innerHTML = '';
        let qIndexOffset = 0;
        parts.forEach((part, partIndex) => {
            const partId = `part-palette-${partIndex}`;
            const header = document.createElement('div');
            header.className = 'palette-part-header';
            header.innerHTML = `<span>${part.name}</span><span id="arrow-${partId}">▼</span>`;
            header.onclick = () => {
                $(`#${partId}`).classList.toggle('hidden');
                $(`#arrow-${partId}`).textContent = $(`#${partId}`).classList.contains('hidden') ? '►' : '▼';
            };
            const grid = document.createElement('div');
            grid.className = 'palette-grid';
            grid.id = partId;
            for (let i = 0; i < part.count; i++) {
                const qNum = qIndexOffset + i + 1;
                const item = document.createElement('div');
                item.className = 'palette-item';
                item.id = `q-palette-${qNum}`;
                item.textContent = qNum;
                item.onclick = () => displayQuestion(qNum - 1);
                grid.appendChild(item);
            }
            container.appendChild(header);
            container.appendChild(grid);
            qIndexOffset += part.count;
        });
    }
    
    function updatePartHeader(index) {
        let qCounter = 0;
        for (const part of quizConfig.structure) {
            if (index < qCounter + part.count) {
                $('#part-name-display').textContent = part.name;
                return;
            }
            qCounter += part.count;
        }
    }
    
    // --- Actions ---
    function handleSave() { if (!userAnswers[currentQuestionIndex]) return; questionStates[currentQuestionIndex].status = 'answered'; navigate(1); }
    function handleReview() { questionStates[currentQuestionIndex].status = 'review'; navigate(1); }
    function handleReviewLock() { if (!userAnswers[currentQuestionIndex]) return; questionStates[currentQuestionIndex] = { status: 'review-lock', locked: true }; navigate(1); }
    function handleClear() { userAnswers[currentQuestionIndex] = null; questionStates[currentQuestionIndex].status = 'not-answered'; updateQuestionUI(); }
    function navigate(dir) { const newIndex = currentQuestionIndex + dir; if (newIndex >= 0 && newIndex < quizData.questions.length) displayQuestion(newIndex); }

    // --- Submission ---
    function confirmSubmit() {
        const unattempted = questionStates.filter(q => ['not-answered', 'not-visited', 'review'].includes(q.status) || q.answer === null).length;
        $('#confirm-modal-text').textContent = `Are you sure you want to submit? ${unattempted > 0 ? `You have ${unattempted} unanswered or un-evaluated questions.` : ''}`;
        $('#confirm-modal-overlay').style.display = 'flex';
        $('#modal-confirm-btn').onclick = () => { $('#confirm-modal-overlay').style.display = 'none'; calculateAndDisplayScore(); };
        $('#modal-cancel-btn').onclick = () => $('#confirm-modal-overlay').style.display = 'none';
    }

    function calculateAndDisplayScore() {
        clearInterval(timerInterval);
        let score = 0, correct = 0, incorrect = 0, unattempted = 0, qIdx = 0;

        quizConfig.structure.forEach(part => {
            for (let i = 0; i < part.count; i++) {
                const idx = qIdx + i;
                const state = questionStates[idx];
                const answer = userAnswers[idx];

                // Answers marked for review are not evaluated
                if (answer === null || state.status === 'review') {
                    unattempted++;
                } else if (answer === answerKey[idx + 1]) {
                    score += part.marks;
                    correct++;
                } else {
                    score -= quizConfig.negativeWeightage;
                    incorrect++;
                }
            }
            qIdx += part.count;
        });

        let keyHtml = '<h3 class="text-xl font-bold mt-8 mb-4 text-left">Answer Key</h3><div class="space-y-2 text-left">';
        userAnswers.forEach((ans, i) => {
            const correctAns = answerKey[i + 1];
            const stateStatus = questionStates[i].status;

            if (stateStatus === 'review') {
                keyHtml += `<div class="p-2 rounded-md bg-yellow-50 border border-yellow-200"><span class="font-bold">Q ${i + 1}:</span> Your Answer: <span class="font-semibold text-yellow-700">${ans || "N/A"} (Marked for Review, Not Evaluated)</span> | Correct: <span class="font-semibold text-blue-600">${correctAns}</span></div>`;
            } else if (ans === null) {
                keyHtml += `<div class="p-2 rounded-md bg-gray-50 border border-gray-200"><span class="font-bold">Q ${i + 1}:</span> Your Answer: <span class="font-semibold text-gray-600">Not Answered</span> | Correct: <span class="font-semibold text-blue-600">${correctAns}</span></div>`;
            } else {
                const isCorrect = ans === correctAns;
                if (isCorrect) {
                    keyHtml += `<div class="p-2 rounded-md bg-green-50 border border-green-200"><span class="font-bold">Q ${i + 1}:</span> Your Answer: <span class="font-semibold text-green-700">${ans}</span> | Correct: <span class="font-semibold text-blue-600">${correctAns}</span></div>`;
                } else {
                    keyHtml += `<div class="p-2 rounded-md bg-red-50 border border-red-200"><span class="font-bold">Q ${i + 1}:</span> Your Answer: <span class="font-semibold text-red-700">${ans}</span> | Correct: <span class="font-semibold text-blue-600">${correctAns}</span></div>`;
                }
            }
        });
        keyHtml += '</div>';

        $('.quiz-container').innerHTML = `<div class="bg-white rounded-lg shadow p-8 w-full"><div class="text-center"><h2 class="text-3xl font-bold">Quiz Completed!</h2><p class="text-lg text-gray-600 my-2">Name: ${$('#userName').value}</p><div class="my-6"><p class="text-5xl font-extrabold text-indigo-600">${score.toFixed(2)}</p><p>Final Score</p></div><div class="grid grid-cols-3 gap-4 text-center border-y py-4 my-6"><div><p class="text-2xl font-bold text-green-600">${correct}</p><p>Correct</p></div><div><p class="text-2xl font-bold text-red-600">${incorrect}</p><p>Incorrect</p></div><div><p class="text-2xl font-bold text-gray-600">${unattempted}</p><p>Unattempted</p></div></div></div>${keyHtml}</div>`;
    }
    
    // --- Utilities ---
    function startTimer(minutes) {
        let secs = minutes * 60;
        timerInterval = setInterval(() => {
            if (secs <= 0) { clearInterval(timerInterval); alert("Time's up!"); calculateAndDisplayScore(); return; }
            secs--;
            $('#timeDisplay').textContent = `${String(Math.floor(secs / 3600)).padStart(2, '0')}:${String(Math.floor((secs % 3600) / 60)).padStart(2, '0')}:${String(secs % 60).padStart(2, '0')}`;
        }, 1000);
    }
    function validateInputs(name, email, quizId) { const e = (m) => { $('#loginError').textContent = m; $('#loginError').style.display = 'block'; }; if (!name || !email || !quizId) { e("All fields are required."); return false; } if (!/^\S+@\S+\.\S+$/.test(email)) { e("Invalid email."); return false; } return true; }
    function handleLoginError(err) { console.error(err); $('#loginError').textContent = err.message; $('#loginError').style.display = 'block'; setLoginLoading(false); }
    function setLoginLoading(isLoading) { $('#startQuizBtn').disabled = isLoading; $('#startQuizBtn').textContent = isLoading ? 'Loading...' : 'Start Quiz'; }

    // ===================================================================================
    //                          CSIR NET CALCULATOR LOGIC
    // ===================================================================================
    const calculator = $('#calculator-modal');
    const display = $('#calculator-display');
    let calcState = { previous: null, operation: null, newEntry: true, isRadianMode: false, isShiftActive: false };

    const syncState = () => { calcState.current = display.textContent; };
    display.addEventListener('input', syncState);

    function clearEntry() {
        display.textContent = '0';
        calcState.newEntry = true;
        syncState();
    }
    function insertAtCursor(text) {
        if (calcState.newEntry) {
            display.textContent = ''; 
            calcState.newEntry = false;
        }
        
        display.focus(); // Set focus to the display
        const selection = window.getSelection();

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            
            const textNode = document.createTextNode(text);
            range.insertNode(textNode);
            
            range.setStartAfter(textNode);
            range.setEndAfter(textNode);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
             // Fallback if no range is found (e.g. element not properly focused)
            display.textContent += text;
        }

        syncState();
    }
    function performOperation() {
        const prev = parseFloat(calcState.previous);
        const curr = parseFloat(display.textContent);
        if (isNaN(prev) || isNaN(curr)) return;
        let result = 0;
        switch (calcState.operation) {
            case '+': result = prev + curr; break;
            case '-': result = prev - curr; break;
            case '*': result = prev * curr; break;
            case '/': result = prev / curr; break;
            case '^': result = Math.pow(prev, curr); break;
        }
        display.textContent = String(result);
        calcState.operation = null;
        calcState.previous = null;
        syncState();
    }
    function chooseOperation(op) {
        if (!calcState.newEntry && calcState.previous !== null) {
             performOperation(); 
        }
        calcState.previous = display.textContent;
        calcState.operation = op;
        calcState.newEntry = true;
    }
    function handleScientific(btn) {
        let func = btn.dataset.value;
        if(calcState.isShiftActive) {
            func = btn.dataset.shiftValue || func;
        }
        
        const val = parseFloat(display.textContent);
        let result = 0;
        switch(func) {
            case 'sin': result = calcState.isRadianMode ? Math.sin(val) : Math.sin(val * (Math.PI / 180)); break;
            case 'cos': result = calcState.isRadianMode ? Math.cos(val) : Math.cos(val * (Math.PI / 180)); break;
            case 'tan': result = calcState.isRadianMode ? Math.tan(val) : Math.tan(val * (Math.PI / 180)); break;
            case 'arcsin': result = calcState.isRadianMode ? Math.asin(val) : Math.asin(val) * (180 / Math.PI); break;
            case 'arccos': result = calcState.isRadianMode ? Math.acos(val) : Math.acos(val) * (180 / Math.PI); break;
            case 'arctan': result = calcState.isRadianMode ? Math.atan(val) : Math.atan(val) * (180 / Math.PI); break;
            case 'log': result = Math.log10(val); break;
            case 'ln': result = Math.log(val); break;
            case 'sqrt': result = Math.sqrt(val); break;
            case 'x-squared': result = Math.pow(val, 2); break;
            case 'reciprocal': result = 1 / val; break;
            case 'negate': result = -val; break;
            case 'pi': result = Math.PI; break;
        }
        display.textContent = String(result);
        calcState.newEntry = true;
        
        if(calcState.isShiftActive) toggleShift(false);
        syncState();
    }
    function backspace() {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;

        const range = selection.getRangeAt(0);
        if (range.collapsed) {
            const start = range.startOffset;
            if (start > 0) {
                 range.setStart(range.startContainer, start - 1);
                 range.deleteContents();
            }
        } else {
            range.deleteContents();
        }

        if(display.textContent === '') display.textContent = '0';
        syncState();
    }
    function moveCursor(dir) {
        const selection = window.getSelection();
        if (!selection.rangeCount) return;
        const range = selection.getRangeAt(0);
        const newPosition = range.startOffset + dir;

        if (newPosition >= 0 && newPosition <= display.textContent.length) {
            range.setStart(range.startContainer, newPosition);
            range.collapse(true);
            selection.removeAllRanges();
            selection.addRange(range);
        }
    }

    function toggleShift(forceState) {
        calcState.isShiftActive = typeof forceState === 'boolean' ? forceState : !calcState.isShiftActive;
        $('.shift-btn').classList.toggle('active', calcState.isShiftActive);
        $('#calculator-modal').classList.toggle('shift-active', calcState.isShiftActive);
    }
    
    // --- Calculator Event Listeners ---
    $('#calculator-mode').addEventListener('click', (e) => {
        const target = e.target.closest('.calc-mode-option');
        if (!target) return;
        calcState.isRadianMode = target.dataset.mode === 'rad';
        document.querySelector('.calc-mode-option.active').classList.remove('active');
        target.classList.add('active');
    });

    $('#calculator-buttons').addEventListener('click', (e) => {
        const target = e.target.closest('.calc-btn');
        if (!target) return;
        const { value } = target.dataset;
        const type = target.classList;

        if (value === 'shift') toggleShift();
        else if (value === 'CE') clearEntry();
        else if (value === 'backspace') backspace();
        else if (value === 'move-left') moveCursor(-1);
        else if (value === 'move-right') moveCursor(1);
        else if (value === '=') {
            if (calcState.operation && calcState.previous !== null) {
                performOperation();
                calcState.newEntry = true;
            }
        }
        else if (type.contains('operator')) {
             if (['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', 'pi', 'x-squared', 'reciprocal'].includes(value)) {
                 handleScientific(target);
             } else {
                 chooseOperation(value);
             }
        }
        else insertAtCursor(value);
    });
    
    // --- Draggable Calculator ---
    $('#calculatorBtn').addEventListener('click', () => {
        calculator.style.display = 'block';
        // Reset position to default centered state each time it's opened
        calculator.style.top = '50%';
        calculator.style.left = '50%';
        calculator.style.transform = 'translate(-50%, -50%)';
    });
    $('#close-calculator-btn').addEventListener('click', () => calculator.style.display = 'none');

    let isDragging = false;
    let shiftX = 0;
    let shiftY = 0;

    const dragStart = (event) => {
        // Prevent dragging when interacting with specific elements inside the calculator
        if (event.target.closest('#calculator-display, #calculator-buttons, .calc-btn, #close-calculator-btn')) {
            return;
        }

        isDragging = true;
        
        // Get the current visual position based on getBoundingClientRect
        const rect = calculator.getBoundingClientRect();

        // Switch from transform-based centering to pixel-based positioning
        // This prevents the "jump" on the first drag
        calculator.style.transform = 'none';
        calculator.style.left = `${rect.left}px`;
        calculator.style.top = `${rect.top}px`;

        const clientX = event.type === 'touchstart' ? event.touches[0].clientX : event.clientX;
        const clientY = event.type === 'touchstart' ? event.touches[0].clientY : event.clientY;
        
        // Calculate the offset of the mouse/touch from the top-left corner of the modal
        shiftX = clientX - rect.left;
        shiftY = clientY - rect.top;
        
        if (event.type === 'touchstart') {
            event.preventDefault();
        }
    };

    const dragMove = (event) => {
        if (!isDragging) return;

        if (event.type === 'touchmove') {
            event.preventDefault();
        }
        
        // Use requestAnimationFrame for a smoother drag effect
        window.requestAnimationFrame(() => {
            if (!isDragging) return; // check again inside animation frame
            const clientX = event.type === 'touchmove' ? event.touches[0].clientX : event.clientX;
            const clientY = event.type === 'touchmove' ? event.touches[0].clientY : event.clientY;
            
            calculator.style.left = `${clientX - shiftX}px`;
            calculator.style.top = `${clientY - shiftY}px`;
        });
    };

    const dragEnd = () => {
        isDragging = false;
    };

    // Mouse events
    calculator.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', dragMove);
    document.addEventListener('mouseup', dragEnd);

    // Touch events
    calculator.addEventListener('touchstart', dragStart, { passive: false });
    document.addEventListener('touchmove', dragMove, { passive: false });
    document.addEventListener('touchend', dragEnd);

    // Prevent default browser drag behavior
    calculator.ondragstart = () => false;


</script>
</body>
</html>

